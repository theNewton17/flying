pico-8 cartridge // http://www.pico-8.com
version 34
__lua__


----util functions
--determines if a specific point on the map is solid
function solid(x,y)
 return fget(mget(x\8,y\8),0)
end

--returns true if something at x,y of size w,h is colliding with the map
function mapcoll(phys, x, y)
 local w_2,h_2=phys.w\2,phys.h\2
 return solid(x-w_2, y-h_2)
  or solid(x+w_2-1, y-h_2)
  or solid(x-w_2, y+h_2-1)
  or solid(x+w_2-1, y+h_2-1)
end

----control systems
physics={}
physics.update = function()
 for phys_comp in all(cur_world.phys_comps) do
  local oldx,oldy = phys_comp.x,phys_comp.y
  --velocity
  phys_comp.x += phys_comp.dx
  phys_comp.y += phys_comp.dy
  --acceleration
  phys_comp.dx = mid(-phys_comp.mdx,phys_comp.dx+phys_comp.ddx,phys_comp.mdx)
  phys_comp.dy = mid(-phys_comp.mdy,phys_comp.dy+phys_comp.ddy,phys_comp.mdy)
  --friction
  if(phys_comp.grounded and phys_comp.ddx == 0) phys_comp.dx *= phys_comp.friction

  if mapcoll(phys_comp, phys_comp.x, oldy) then
   phys_comp.x = oldx
   phys_comp.dx = 0
  end
  if mapcoll(phys_comp, oldx, phys_comp.y) then
   phys_comp.y = oldy
   phys_comp.grounded = phys_comp.dy>0
   phys_comp.dy = 0
  end
 end
end

controls={}
controls.update = function()
 local grnd = player.phys_comp.grounded
 if grnd and btnp(2) then
  player.phys_comp.grounded = false
  player.phys_comp.dy = -player.phys_comp.mdy
 end

 player.phys_comp.ddx=0
 local left,right = btn(0),btn(1)
 if not (left and right) then
  if(left)player.phys_comp.ddx = (grnd and -0.2 or -0.05)
  if(right)player.phys_comp.ddx = (grnd and 0.2 or 0.05)
 end
end

----components
function new_phys(x, y, w, h, dx, dy)
 local p = {x=x,y=y,w=w,h=h,
  dx=dx,dy=dy,mdx=1,mdy=2.5,
  ddx=0,ddy=0.15,friction=0.7,
  grounded=false}
 add(cur_world.phys_comps, p)
 return p
end

function new_entity(phys_comp)
 local e={
  phys_comp=phys_comp
 }
 add(cur_world.entities, e)
 return e
end

function _init()
 overworld={map={},entities={},phys_comps={}}
 cur_world=overworld

 player=new_entity(
  new_phys(80,100,7,7,0,0)
 )
end

function _update()
 controls.update()
 physics.update()
end

function _draw()
 cls()
 map(0,0,0,0,16,16)
 spr(0, player.phys_comp.x-4, player.phys_comp.y-4)
 print(player.phys_comp.dx, 1, 1)
end


__gfx__
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010001010100000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
