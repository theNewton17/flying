pico-8 cartridge // http://www.pico-8.com
version 34
__lua__

----util functions
--determines if a specific point on the map is solid
function solid(x,y)
 return fget(mget(x\8,y\8),0)
end

--returns true if something at x,y of size w,h is colliding with the map
function mapcoll(phys, x, y)
 local w_2,h_2=phys.w\2,phys.h\2
 return solid(x-w_2, y-h_2)
  or solid(x+w_2-1, y-h_2)
  or solid(x-w_2, y+h_2-1)
  or solid(x+w_2-1, y+h_2-1)
end

----components
function new_phys(x, y, w, h, dx, dy)
 local p = {x=x,y=y,w=w,h=h,
  dx=dx,dy=dy,mdx=1,mdy=1.8,
  ddx=0,ddy=0.15,friction=0.7,
  grounded=false}
  
 p.update = function(self)
  if(self.dy>0) self.grounded=false
  local oldx,oldy = self.x,self.y
  --velocity
  self.x += self.dx
  self.y += self.dy
  --acceleration
  self.dx = mid(-self.mdx,self.dx+self.ddx,self.mdx)
  self.dy = mid(-self.mdy,self.dy+self.ddy,self.mdy)
  --friction
  if(self.grounded and self.ddx == 0) self.dx *= self.friction

  if mapcoll(self, self.x, oldy) then
   self.x = oldx
   self.dx = 0
  end
  
  if mapcoll(self, oldx, self.y) then
   self.y = oldy
   self.grounded = self.dy>0
   self.dy = 0
  end
 end

 return p
end

function new_player(x,y)
 local p = {phys_comp=new_phys(x,y,7,7,0,0)}

 p.update = function(self)
  --player controls
  local grnd = self.phys_comp.grounded
  if grnd and btnp(2) then
   self.phys_comp.grounded = false
   self.phys_comp.dy = -self.phys_comp.mdy
  end

  self.phys_comp.ddx=0
  local left,right = btn(0),btn(1)
  if not (left and right) then
   if(left) self.phys_comp.ddx = (grnd and -0.2 or -0.05)
   if(right) self.phys_comp.ddx = (grnd and 0.2 or 0.05)
  end

  p.phys_comp:update()
 end

 p.draw = function(self)
  spr(0, self.phys_comp.x-4, self.phys_comp.y-4)
 end

 add(cur_world.entities, p)
 return p
end

function _init()
 overworld={map={},entities={}}
 cur_world=overworld

 player=new_player(80,100)
end

function _update()
 for e in all(cur_world.entities) do
  e:update()
 end
end

function _draw()
 cls()
 map(0,0,0,0,16,16)
 for e in all(cur_world.entities) do
  e:draw()
 end
end


__gfx__
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010000000000010101010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000010100000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000010101010101010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010000000100000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010100010101000000010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
